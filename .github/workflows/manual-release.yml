name: Manual Release XCFramework

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Force a version bump (major, minor, patch). Leave empty for auto-detection."
        required: false
        default: ""

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: calc
        run: |
          chmod +x .github/scripts/detect-lib-change-git.sh .github/scripts/bump-version.sh

          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          PREV_VERSION=${PREV_TAG#v}

          if [ -n "${{ github.event.inputs.bump }}" ]; then
            echo "Manual bump requested: ${{ github.event.inputs.bump }}"
            CHANGE_LEVEL="${{ github.event.inputs.bump }}"
          else
            CHANGE_LEVEL=$(bash .github/scripts/detect-lib-change-git.sh "$PREV_TAG")
          fi

          NEW_VERSION=$(bash .github/scripts/bump-version.sh "$PREV_VERSION" "$CHANGE_LEVEL")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Calculated new version: $NEW_VERSION ($CHANGE_LEVEL)"

      - name: Tag and push new version
        run: |
          git tag v${{ steps.calc.outputs.version }}
          git push origin v${{ steps.calc.outputs.version }}
          git push

      - name: Build XCFramework
        run: ./gradlew buildReleaseXCFramework

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.calc.outputs.version }}
          name: Release v${{ steps.calc.outputs.version }}
          body: |
            Automated release based on library versions.
            **Embedded libs**
            - keypleInteropJsonapiClientKmpLib: $(grep 'keypleInteropJsonapiClientKmpLib' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
            - keypleInteropLocalreaderNfcmobileKmpLib: $(grep 'keypleInteropLocalreaderNfcmobileKmpLib' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
          files: build/XCFrameworks/*.zip
