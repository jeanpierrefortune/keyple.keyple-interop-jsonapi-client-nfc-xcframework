name: Manual Release XCFramework

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Force a version bump (major, minor, patch). Leave empty for auto-detection."
        required: false
        default: ""

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for accessing tags

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Determine next version
        id: calc
        run: |
          chmod +x .github/scripts/detect-lib-change.sh .github/scripts/bump-version.sh

          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          PREV_VERSION=${PREV_TAG#v}

          if [ -n "${{ github.event.inputs.bump }}" ]; then
            echo "Manual bump requested: ${{ github.event.inputs.bump }}"
            CHANGE_LEVEL="${{ github.event.inputs.bump }}"
          else
            CHANGE_LEVEL=$(bash .github/scripts/detect-lib-change.sh "$PREV_VERSION")
          fi

          NEW_VERSION=$(bash .github/scripts/bump-version.sh "$PREV_VERSION" "$CHANGE_LEVEL")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Calculated new version: $NEW_VERSION ($CHANGE_LEVEL)"

      - name: Update version-info.json
        run: |
          LIB_A=$(grep 'keypleInteropJsonapiClientKmpLib' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
          LIB_B=$(grep 'keypleInteropLocalreaderNfcmobileKmpLib' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
          echo "{
            \"__generated_by_ci\": \"This file is automatically generated by the GitHub Actions workflow. Do not edit manually.\",
            \"keypleInteropJsonapiClientKmpLib\": \"$LIB_A\",
            \"keypleInteropLocalreaderNfcmobileKmpLib\": \"$LIB_B\"
          }" > version-info.json

      - name: Commit version-info.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add version-info.json
          git commit -m "chore: update version-info.json for release v${{ steps.calc.outputs.version }}" || echo "No changes to commit"

      - name: Tag and push new version
        run: |
          git tag v${{ steps.calc.outputs.version }}
          git push origin v${{ steps.calc.outputs.version }}
          git push

      - name: Build XCFramework
        run: ./gradlew buildReleaseXCFramework

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.calc.outputs.version }}
          name: Release v${{ steps.calc.outputs.version }}
          body: |
            Automated release based on library versions.

            **Embedded libs**
            - keypleInteropJsonapiClientKmpLib: $(grep 'keypleInteropJsonapiClientKmpLib' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
            - keypleInteropLocalreaderNfcmobileKmpLib: $(grep 'keypleInteropLocalreaderNfcmobileKmpLib' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
          files: build/XCFrameworks/*.zip
