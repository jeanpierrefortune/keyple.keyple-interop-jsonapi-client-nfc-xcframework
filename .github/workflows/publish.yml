name: Publish iOS XCFramework

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'The release version (e.g., 1.2.3)'
        required: true

jobs:
  publish:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17 (required for Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build XCFramework
        run: ./gradlew assembleXCFramework --no-daemon

      - name: Zip artifact
        run: |
          # The zip command is now executed from inside the release directory
          # to ensure the zip file does not contain a folder hierarchy.
          cd build/XCFrameworks/release
          zip -r ../../../keyple-interop-jsonapi-client-nfc-xcframework.zip keyple_interop_jsonapi_client_nfc_xcframework.xcframework

      - name: Compute checksum
        id: compute_checksum
        run: |
          CHECKSUM=$(swift package compute-checksum keyple-interop-jsonapi-client-nfc-xcframework.zip)
          echo "checksum=$CHECKSUM" >> $GITHUB_ENV
          echo "Computed checksum: $CHECKSUM"

      - name: Update Package.swift file
        run: |
          TIMESTAMP=" // Generated on $(date '+%Y-%m-%d %H:%M:%S')"
          PERMALINK="https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag }}/keyple-interop-jsonapi-client-nfc-xcframework.zip"
          
          # 1. Replace the URL value
          sed -i '' "s|url: \".*\"|url: \"$PERMALINK\"|" Package.swift
          
          # 2. Replace the checksum value (avec ou sans espace apr√®s checksum:)
          sed -i '' "s|checksum: *\"[^\"]*\").*$|checksum: \"${{ env.checksum }}\")$TIMESTAMP|" Package.swift
          
          echo "Package.swift has been updated with the permalink, checksum and timestamp."
          cat Package.swift

      - name: Commit and tag changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Package.swift
          git commit -m "Update Package.swift for release ${{ github.event.inputs.tag }}"
          git tag ${{ github.event.inputs.tag }}
          git push
          git push --tags

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          body: "XCFramework release for ${{ github.event.inputs.tag }}"
          files: keyple-interop-jsonapi-client-nfc-xcframework.zip
